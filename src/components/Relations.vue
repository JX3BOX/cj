<template>
    <div class="m-block m-relations m-boss">
        <div class="m-section">
            <div style="padding:5px 0;text-align:center">
                <span v-if="relations === null">Loading...</span>
                <span v-if="relations === false">⚠️ 数据加载异常</span>
                <span v-if="relations && !relations.length">💧 无相关数据</span>
            </div>
            <ul class="m-relations-list" v-if="relations && relations.length">
                <li v-for="(cj, key) in relations" :key="key">
                    <router-link
                        class="u-title"
                        :to="{ name: 'view', params: { cj_id: cj.ID } }"
                    >
                        <img
                            class="u-icon"
                            :src="resolveIconPath(cj.IconID)"
                            @error.once="iconErrorHandler($event)"
                        />
                        <span class="u-text" v-text="cj.Name"></span>
                    </router-link>
                </li>
            </ul>
        </div>
        <div class="m-section m-bossinfos" v-show="!show_primary">
            <ul class="m-bossinfo">
                <li class="u-id">ID:{{ npc.ID }}</li>
                <li class="u-name">{{ npc.Name }}</li>
                <li class="u-desc">称谓<em>Title</em>{{ npc.Title }}</li>
                <li class="u-desc">等级<em>Level:</em>{{ npc.Level }}</li>
                <li class="u-desc">
                    强度<em>Intensity</em>{{ npc.Intensity }}
                </li>
                <li class="u-desc">地图<em>MapName</em>{{ npc.MapName }}</li>
                <li class="u-desc">
                    备注<em>_Notation</em>{{ npc._Notation }}
                </li>

                <li class="u-desc">血量<em>MaxLife</em>{{ npc.MaxLife }}</li>
                <li class="u-desc">蓝量<em>MaxMana</em>{{ npc.MaxMana }}</li>
                <li class="u-desc">跑速<em>RunSpeed</em>{{ npc.RunSpeed }}</li>
                <li class="u-desc">
                    移速<em>WalkSpeed</em>{{ npc.WalkSpeed }}
                </li>
                <li class="u-desc" title="攻击补偿距离/64">
                    体积<em>TouchRange</em>{{ npc.TouchRange }}
                </li>
            </ul>

            <ul class="m-bossinfo">
                <li class="u-desc">识破<em>Sense</em>{{ npc.Sense }}</li>
                <li class="u-desc">闪避<em>Dodge</em>{{ npc.Dodge }}</li>
                <li class="u-desc">
                    外功防御<em>PhysicsShieldBase</em
                    >{{ npc.PhysicsShieldBase }}
                </li>
                <li class="u-desc">
                    混元防御<em>NeutralMagicDefence</em
                    >{{ npc.NeutralMagicDefence }}
                </li>
                <li class="u-desc">
                    阳性防御<em>SolarMagicDefence</em
                    >{{ npc.SolarMagicDefence }}
                </li>
                <li class="u-desc">
                    阴性防御<em>LunarMagicDefence</em
                    >{{ npc.LunarMagicDefence }}
                </li>
                <li class="u-desc">
                    毒性防御<em>PoisonMagicDefence</em
                    >{{ npc.PoisonMagicDefence }}
                </li>
            </ul>

            <ul class="m-bossinfo">
                <li class="u-desc">
                    外功会心<em>PhysicsCriticalStrike</em
                    >{{ npc.PhysicsCriticalStrike }}
                </li>
                <li class="u-desc">
                    混元会心<em>NeutralCriticalStrike</em
                    >{{ npc.NeutralCriticalStrike }}
                </li>
                <li class="u-desc">
                    阳性会心<em>SolarCriticalStrike</em
                    >{{ npc.SolarCriticalStrike }}
                </li>
                <li class="u-desc">
                    阴性会心<em>LunarCriticalStrike</em
                    >{{ npc.LunarCriticalStrike }}
                </li>
                <li class="u-desc">
                    毒性会心<em>PoisonCriticalStrike</em
                    >{{ npc.PoisonCriticalStrike }}
                </li>
            </ul>

            <ul class="m-bossinfo">
                <li class="u-desc">
                    外功命中<em>PhysicsAttackHit</em>{{ npc.PhysicsAttackHit }}
                </li>
                <li class="u-desc">
                    混元命中<em>NeutralMagicHit</em>{{ npc.NeutralMagicHit }}
                </li>
                <li class="u-desc">
                    阳性命中<em>SolarMagicHit</em>{{ npc.SolarMagicHit }}
                </li>
                <li class="u-desc">
                    阴性命中<em>LunarMagicHit</em>{{ npc.LunarMagicHit }}
                </li>
                <li class="u-desc">
                    毒性命中<em>PoisonMagicHit</em>{{ npc.PoisonMagicHit }}
                </li>
            </ul>

            <ul class="m-bossinfo">
                <li class="u-desc">
                    血条是否可见<em>CanSeeLifeBar</em>{{ npc.CanSeeLifeBar }}
                </li>
                <li class="u-desc">
                    是否可被选择<em>IsSelectable</em>{{ npc.IsSelectable }}
                </li>

                <li class="u-desc">
                    复活时间<em>ReviveTime</em>{{ npc.ReviveTime }}
                </li>
            </ul>
        </div>
    </div>
</template>

<script>
const { JX3BOX } = require("@jx3box/jx3box-common");

export default {
    name: "Relation",
    props: ["achievement_id", "show_primary"],
    data: function() {
        return {
            relations: {},
            npcid: 0,
            dungeon_id: null,
            npc: {},
        };
    },
    computed: {},
    methods: {
        getRelationList() {
            let that = this;
            this.$http({
                method: "GET",
                url: `${JX3BOX.__helperUrl}api/achievement/${this.achievement_id}/relations`,
                headers: { Accept: "application/prs.helper.v2+json" },
                withCredentials: true,
            }).then(function(data) {
                data = data.data;
                if (data.code !== 200 || !data.data.relations.length) {
                    return;
                }

                let result = data.data;
                that.npcid = result.boss_id;
                that.dungeon_id = result.dungeon_id;
                that.relations = result.relations;
                that.$emit("relations_got", that.relations);

                // 获取boss信息
                that.getBossInfo(that.npcid);
            });
        },
        resolveIconPath(id) {
            return id
                ? JX3BOX.__ossMirror + "icon/" + id + ".png"
                : JX3BOX.__ossMirror + "image/common/nullicon.png";
        },
        iconErrorHandler(e) {
            e.target.src = JX3BOX.__ossMirror + "image/common/nullicon.png";
        },
        // 获取boss信息
        getBossInfo(npcid) {
            npcid &&
                this.$http
                    .get(`${JX3BOX.__node}npc/id/${npcid}`)
                    .then((res) => {
                        this.npc = (res.data.length && res.data[0]) || {};
                    });
        },
    },
    mounted: function() {
        if (typeof this.show_primary === "undefined") this.show_primary = true;
    },
    watch: {
        achievement_id: {
            immediate: true,
            handler() {
                //数据加载
                if (this.achievement_id) this.getRelationList();
            },
        },
    },
};
</script>

<style lang="less">
    @import '../assets/css/relation.less';
</style>
